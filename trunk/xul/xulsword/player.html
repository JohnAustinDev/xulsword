<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!--
    This file is part of xulSword.

    Copyright 2009 John Austin (gpl.programs.info@gmail.com)

    xulSword is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 2 of the License, or
    (at your option) any later version.

    xulSword is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with xulSword.  If not, see <http://www.gnu.org/licenses/>.
!-->
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=windows-1250">
  <meta name="generator" content="PSPad editor, www.pspad.com">
  <title>Player</title>
  <link rel="stylesheet" href="chrome://xulsword/skin/style.css" type="text/css">
  
  <script>var UseBibleObjectFrom = "MainWindowBible";</script>
  <script src="chrome://xulsword/content/common0.js" type="text/javascript"></script>
  <script src="chrome://xulsword/content/common1.js" type="text/javascript"></script>
  <script src="chrome://xulsword/content/common2.js" type="text/javascript"></script>
  <script src="chrome://xulsword/content/AC_QuickTime.js" type="text/javascript"></script>

<script type="text/javascript">

var Skp=0;
  
function checkAndEmbedPlayer() {
  var player = MainWindow.Player;
  var quit = false;
  if (!player || !player.version || !player.book || !player.chapter) {MainWindow.endAudioPlayer(); return;}
  
  if (player.installMonInterval) {MainWindow.endAudioPlayer(); return;}
  
  if (MainWindow.AudioDirs === null) MainWindow.AudioDirs = getAudioDirs();
  var audiofile = MainWindow.getAudioForChapter(player.version, player.book, player.chapter, MainWindow.AudioDirs);
  if (!audiofile) {MainWindow.endAudioPlayer(); return;}
  
  jsdump("Have audio file:" + player.book + " " + player.chapter + "\n");
  
  if (!MainWindow.checkQuickTime(true)) {MainWindow.endAudioPlayer(); return;}

  embedPlayer(audiofile);
}


function embedPlayer(audiofile) {
jsdump("Now embedding: File://" + audiofile.path + "\n");
  if (MainWindow.Player.volume || MainWindow.Player.volume==0) {
    if (MainWindow.Player.volume <= 50) MainWindow.Player.volume=20; // don't start out muted...
    var vol = "volume=\"" + Math.round(MainWindow.Player.volume/2.56) + "\" ";
  }
  else vol = "";
  // NOTE: setting wmode="transparent" seems to fix a QuickTime plugin bug which permanently hid the controller...
  document.write("<embed src=\"File://" + audiofile.path + "\" width=\"210\" height=\"24\" name=\"player\" autoplay=\"True\" postdomevents=\"True\" enablejavascript=\"True\" type=\"audio/x-mp3\" controller=\"True\" wmode=\"transparent\" kioskmode=\"True\" SHOWLOGO=\"False\"" + vol + "></embed>");
  document.getElementById("playerDiv").addEventListener("qt_load", playerHasLoaded, false);
  document.getElementById("playerDiv").addEventListener("qt_volumechange", volumeChanged, false);
  document.getElementById("playerDiv").addEventListener("qt_ended", finishedAudioFile, false);
}

function finishedAudioFile() {
  if (MainWindow.Player.isPinned) {
    MainWindow.endAudioPlayer()
    return;
  }
  MainWindow.handleNextPrev("next.chapter.player");
  MainWindow.Player.book = Bible.getBookName();
  MainWindow.Player.chapter = Bible.getChapterNumber(MainWindow.Player.version);
  windowLocationReload();
}

function playerHasLoaded() {
  // Sometimes this is needed to recover the QuickTime controller from "black Box" syndrome...
  window.setTimeout("MainWindow.document.getElementById('player').style.visibility = 'hidden';", 1);
  window.setTimeout("MainWindow.document.getElementById('player').style.visibility = 'visible';", 1000);
}

var LastVolume;
function volumeChanged() {
  if (LastVolume && document.player.GetVolume() == LastVolume) return; // Many identical events are called during one move of the slider
  MainWindow.Player.volume = document.player.GetVolume();
  LastVolume = MainWindow.Player.volume;        
}

</script>

  </head>
  
  <body style="position:relative; top:-4px; left:-6;">
  
  <div id="playerDiv">
    <script type="text/javascript">if (!window.frameElement.ownerDocument.getElementById("player").hidden) checkAndEmbedPlayer();</script>
  </div>
  
  </body>
</html>
